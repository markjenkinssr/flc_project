{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Advisor Access - FLC Registration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<main class="container mt-5">

  <h1 class="mb-4 text-primary">Advisor Access</h1>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags|default:'info' }}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <!-- Post explicitly to the user_access view -->
  <form method="post" id="advisor-access-form" action="{% url 'registrations:user_access' %}" aria-label="Advisor Access Form" novalidate>
    {% csrf_token %}

    <div class="mb-3">
      <label for="id_category" class="form-label">Select Category</label>
      {{ form.category }}
      {% if form.category.errors %}<div class="text-danger small">{{ form.category.errors }}</div>{% endif %}
    </div>

    <div class="mb-3">
      <label for="id_name" class="form-label">Select Name</label>
      {{ form.name }}
      {% if form.name.errors %}<div class="text-danger small">{{ form.name.errors }}</div>{% endif %}
      <div class="form-text">This list loads after you choose a category.</div>
    </div>

    <div class="mb-3">
      <label for="id_email" class="form-label">Email</label>
      <input id="id_email" class="form-control" type="email" readonly>
      <div class="form-text">Shown for confirmation only; not submitted.</div>
    </div>

    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'registrations:request_access' %}">
        Request Access (no account)
      </a>
      <button type="submit" class="btn btn-primary">Access Registration Form</button>
    </div>
  </form>
</main>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
$(function () {
  const $category = $('#id_category');
  const $name = $('#id_name');
  const $email = $('#id_email');

  function resetNameSelect(placeholder) {
    $name.empty().append(`<option value="">${placeholder}</option>`);
    $email.val('');
  }

  $category.on('change', function () {
    const categoryVal = $(this).val();
    resetNameSelect('Loadingâ€¦');

    if (!categoryVal) {
      resetNameSelect('Select Name');
      return;
    }

    $.ajax({
      url: "{% url 'registrations:get_names_by_category' %}",
      data: { category: categoryVal },
      dataType: "json"
    }).done(function (data) {
      const names = data.names || [];
      resetNameSelect('Select Name');

      // IMPORTANT: option value is the PendingUser.id (what the server expects)
      names.forEach(function (u) {
        const full = u.full_name || (u.first_name + ' ' + u.last_name);
        $name.append(`<option value="${u.id}" data-email="${u.email || ''}">${full}</option>`);
      });
    }).fail(function () {
      resetNameSelect('Error loading names');
    });
  });

  $name.on('change', function () {
    const email = $(this).find(':selected').data('email') || '';
    $email.val(email);
  });
});
</script>
</body>
</html>
